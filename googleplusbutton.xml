<?xml version="1.0" encoding="UTF-8" ?> 
<Module>
  <ModulePrefs title="Google plus"    
  scrolling="true"> 
	<Require feature="idi"/>
    <Require feature="locked-domain" />
	<Require feature="dynamic-height"/>
	<Require feature="setprefs" />
  </ModulePrefs>
<Content type="html">
<![CDATA[

  
    <script src="https://www.google.com/jsapi" type="text/javascript"></script>
    <!--<script src="https://leanobservatory.googlecode.com/svn/trunk/js/common.js"></script>-->
    <title>GetUser</title>
  
  	<script type="text/javascript">
     var mail;
     var martincito;
	console.log("version 13 jor");
  	var entorno;
  	var llave;
	var url = window.location.host;
	var urlparent = gadgets.util.getUrlParameters()["parent"];
	var returnedJSON;
		
		
	llave = "1063639960042.apps.googleusercontent.com";
		 		
	
	
	
	function createb(){
		// 'Getting' data-attributes using getAttribute
		var zombi = document.getElementById('signp');
		//var fruitCount = plant.getAttribute('data-clientid'); // fruitCount = '12'

		// 'Setting' data-attributes using setAttribute
		zombi.setAttribute('data-clientid',llave); // Pesky birds

	  
       var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
       po.src = 'https://apis.google.com/js/client:plusone.js';
       var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
    
	}
	
	function newpostReq(url,callBack){
		console.log("entro en function newpostReq (url,callBack)");
		    var xmlhttp;
		    if (window.XDomainRequest)
		    {
		        xmlhttp=new XDomainRequest();
		        xmlhttp.onload = function(){callBack(xmlhttp.responseText)};
		    }
		    else if (window.XMLHttpRequest)
		        xmlhttp=new XMLHttpRequest();
		    else
		        xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
		    xmlhttp.onreadystatechange=function()
		    {
		        if (xmlhttp.readyState==4 && xmlhttp.status==200)
		            callBack(xmlhttp.responseText);
		    }

		    xmlhttp.open("GET",url,true);
		    xmlhttp.send();
		}
	
  	
  	function signinCallback(authResult) {
	  console.log("entro en signinCallback");
	  console.log("authResult['access_token'] "+authResult['access_token']);
  	    
          if (authResult['access_token']) {
       // Successfully authorized
       // Hide the sign-in button now that the user is authorized, for example:
       document.getElementById('signinButton').setAttribute('style', 'display: none');
  	    
		gapi.client.load('oauth2', 'v2', function() {
			gapi.client.oauth2.userinfo.get().execute(function(resp) {
				// Shows user email
        mail= resp.email;
				martincito = resp.email;           
        document.getElementById("mail").innerHTML = martincito;
			console.log("Log: " + martincito);
			console.log("entro en gapi.client.oauth2.userinfo.get().execute(function(resp)");
			sendQuery(martincito);
            getPermissions();
			})
  		});		
		console.log("martincito "+martincito);	
		var urlaux = "https://script.google.com/a/macros/bbva.com/s/AKfycbyCvKr4gZa9ER4_Q063fbYbK-_NC2l1CUy4EXa-JaIh/dev?email="+martincito+"&url="+urlparent;
		console.log("urlaux "+urlaux);
		newpostReq(urlaux, function(jsonString) {
			returnedJSON = String(jsonString);
			console.log("returnedJSON "+returnedJSON);
		});
      
     console.log("Mail: " + mail);
     console.log("fin");
  }else {
				var html="";
				html +='<div class="bloqueEnlaces">';
				html +='	Español <a target="_parent" href="https://sites.google.com/a/bbva.com/sercoeco/" class="enlaceMenu">| English</a>';
				html +='</div>';
				html +='<div class="cabeceramenu">';
				html +='<ul>';
				html +='<li id="home" class="op1"><a class="enlace" href="https://sites.google.com/a/bbva.com/sercoeco/"   target="_parent"  title="home"/></li>';
				html +='<li id="consumo" class="op2"><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/consumo"  target="_parent">Consumo</a></span></span></li>';
				html +='<li id="personal" class="op3" ><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/personal"  target="_parent">Personal</a></span></span></li>';
                html +='<li id="reciclado" class="op4"><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/reciclado"  target="_parent">Reciclado</a></span></span></li>';
				//html +='<li id="factores" class="op5"><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/factores-de-conversion"  target="_parent">Factores de conversión</a></span></span></li>';
				//html +='<li id="cambio" class="op6"><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/tipo-de-cambio"  target="_parent">Tipo de cambio</a></span></span></li>';
				//html +='<li id="empleados" class="op7"><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/empleados"  target="_parent" >Empleados</a></span></span></li>';
				//html +='<li id="admin" class="op8"><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/administracion"  target="_parent" >Administración</a></span></span></li>';
				//html +='</ul></div>';
				document.getElementById('insertmenu').innerHTML = html;
				
  
  }
  		  
  	  
  	}
     
     function getPermissions(){
     mail = document.getElementById("mail").innerHTML;
     //alert(mail);
     
     }

  	</script>
    
        
    
  <script src="https://sites.google.com/a/bbva.com/leanobservatory/jquery.js?attredirects=0&d=1" language="JavaScript"></script>
	
<script type="text/javascript">

var urlTable = "https://docs.google.com/a/bbva.com/spreadsheet/ccc?key=0ApZ6EoQT3skrdHd3ck5TVjFwbVo3WmUxQ01PNkZYUUE";

function sendQuery(usermail) 
			{
				gadgetHelper = new google.visualization.GadgetHelper();
				var opts = {dataType:'jsonp'};		
				var query = new google.visualization.Query(urlTable, opts);					
			   
				var querytosend = "select * where G like '%usermail%'  ";
				
				query.setQuery(querytosend);			  
				query.send(handleQueryResponse);
				
				
			}

function handleQueryResponse(response) {
	data = response.getDataTable();	
	var filas = data.getNumberOfRows();
	var html = "";
		for(var i=0;i<filas;i++){
		    var permiso = data.getValue(i,1);
			
			if(permiso.indexOf("ADMIN") != -1){
			    html +='<div class="bloqueEnlaces">';
				html +='	Español <a target="_parent" href="https://sites.google.com/a/bbva.com/sercoeco/" class="enlaceMenu">| English</a>';
				html +='</div>';
				html +='<div class="cabeceramenu">';
				html +='<ul>';
				html +='<li id="home" class="op1"><a class="enlace" href="https://sites.google.com/a/bbva.com/sercoeco/"   target="_parent"  title="home"/></li>';
				html +='<li id="consumo" class="op2"><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/consumo"  target="_parent">Consumo</a></span></span></li>';
				html +='<li id="personal" class="op3" ><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/personal"  target="_parent">Personal</a></span></span></li>';
                html +='<li id="reciclado" class="op4"><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/reciclado"  target="_parent">Reciclado</a></span></span></li>';
				html +='<li id="factores" class="op5"><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/factores-de-conversion"  target="_parent">Factores de conversión</a></span></span></li>';
				html +='<li id="cambio" class="op6"><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/tipo-de-cambio"  target="_parent">Tipo de cambio</a></span></span></li>';
				html +='<li id="empleados" class="op7"><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/empleados"  target="_parent" >Empleados</a></span></span></li>';
				html +='<li id="admin" class="op8"><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/administracion"  target="_parent" >Administración</a></span></span></li>';
				html +='</ul></div>';
			}else{
				html +='<div class="bloqueEnlaces">';
				html +='	Español <a target="_parent" href="https://sites.google.com/a/bbva.com/sercoeco/" class="enlaceMenu">| English</a>';
				html +='</div>';
				html +='<div class="cabeceramenu">';
				html +='<ul>';
				html +='<li id="home" class="op1"><a class="enlace" href="https://sites.google.com/a/bbva.com/sercoeco/"   target="_parent"  title="home"/></li>';
				html +='<li id="consumo" class="op2"><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/consumo"  target="_parent">Consumo</a></span></span></li>';
				html +='<li id="personal" class="op3" ><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/personal"  target="_parent">Personal</a></span></span></li>';
                html +='<li id="reciclado" class="op4"><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/reciclado"  target="_parent">Reciclado</a></span></span></li>';
				//html +='<li id="factores" class="op5"><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/factores-de-conversion"  target="_parent">Factores de conversión</a></span></span></li>';
				//html +='<li id="cambio" class="op6"><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/tipo-de-cambio"  target="_parent">Tipo de cambio</a></span></span></li>';
				//html +='<li id="empleados" class="op7"><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/empleados"  target="_parent" >Empleados</a></span></span></li>';
				//html +='<li id="admin" class="op8"><span class="enlace" tabindex="0"><span><a href="https://sites.google.com/a/bbva.com/sercoeco/home/administracion"  target="_parent" >Administración</a></span></span></li>';
				//html +='</ul></div>';
			
			}
		document.getElementById('insertmenu').innerHTML = html;
		}

}
</script>


	<body onload="createb()">
		<p id="text"></p>
		<span id="signinButton">
		  <span
		  	id="signp"
		    class="g-signin"
		    data-clientid="xxx"
		    data-callback="signinCallback"
		    data-cookiepolicy="single_host_origin"
		    data-requestvisibleactions="http://schemas.google.com/AddActivity"
		    data-scope="https://www.googleapis.com/auth/userinfo.email">
		  </span>
		</span>
	  
		
      
        <input type="hidden" id="mail"></input>
		
	<div id="insertmenu"></div>	
	</body>
 ]]>	
</Content>
</Module>